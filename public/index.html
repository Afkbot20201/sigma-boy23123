<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Nemesis Chess</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#020617; --panel:#020617; --glass:#020617;
      --accent:#6366f1; --accent-soft:#4f46e5;
      --muted:#9ca3af; --danger:#f97373; --success:#22c55e;
      --rank-bronze:#b45309; --rank-silver:#9ca3af; --rank-gold:#eab308;
      --rank-plat:#22c55e; --rank-diamond:#0ea5e9; --rank-nemesis:#f97316;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{margin:0;min-height:100vh;background:radial-gradient(circle at top,#020617,#020617 40%,#000 100%);color:#e5e7eb;display:flex;align-items:center;justify-content:center;padding:16px;}
    .app{width:1180px;max-width:100%;display:grid;grid-template-columns:360px 1fr;gap:18px;}
    .card{background:rgba(15,23,42,0.96);border-radius:18px;padding:18px;box-shadow:0 25px 70px rgba(15,23,42,0.9);position:relative;overflow:hidden;}
    h1{margin:0;font-size:20px;}
    .sub{margin-top:4px;color:var(--muted);font-size:13px;}
    .tabs{display:flex;gap:6px;margin-top:14px;margin-bottom:16px;}
    .tab{flex:1;text-align:center;padding:7px 8px;border-radius:999px;font-size:12px;cursor:pointer;border:1px solid transparent;color:var(--muted);}
    .tab.active{background:radial-gradient(circle at top left,#4f46e5,#0f172a);color:#e5e7eb;border-color:rgba(129,140,248,0.8);box-shadow:0 8px 24px rgba(79,70,229,0.55);}
    .stack{display:flex;flex-direction:column;gap:10px;}
    .row{display:flex;gap:8px;}
    input,button{border-radius:10px;border:1px solid rgba(148,163,184,0.35);padding:9px 10px;font-size:14px;background:rgba(15,23,42,0.9);color:inherit;}
    button{cursor:pointer;font-weight:600;background:linear-gradient(90deg,var(--accent),var(--accent-soft));border:none;color:white;}
    button.secondary{background:transparent;border:1px solid rgba(148,163,184,0.5);color:var(--muted);}
    button.full{width:100%;}
    .hint{font-size:11px;color:var(--muted);}
    .status{margin-top:6px;font-size:12px;color:var(--muted);}

    /* Right side */
    .header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .pill{font-size:12px;color:var(--muted);}
    .pill strong{color:#e5e7eb;}
    #gameContainer{display:none;}
    #emptyState{height:360px;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;color:var(--muted);font-size:13px;}
    #emptyState h2{color:#e5e7eb;margin-bottom:6px;font-size:18px;}
    #boardWrap{display:flex;gap:14px;}
    #board{display:grid;grid-template-columns:repeat(8,66px);grid-template-rows:repeat(8,66px);border-radius:14px;overflow:hidden;box-shadow:0 0 0 1px rgba(15,23,42,0.9),0 18px 40px rgba(15,23,42,0.9);background:#020617;transition:transform 0.25s ease;}
    .square{display:flex;align-items:center;justify-content:center;font-size:32px;user-select:none;cursor:pointer;position:relative;transition:background 0.1s,transform 0.1s;}
    .light{background:#f2e6d4;}
    .dark{background:#b58863;}
    .square.selected{box-shadow:inset 0 0 0 3px rgba(59,130,246,0.9);}
    .square.kill::after{
      content:"";
      position:absolute;inset:10px;border-radius:12px;
      border:2px solid rgba(248,113,113,0.95);
      box-shadow:0 0 22px rgba(248,113,113,0.95);
      animation:kill 260ms ease-out;
    }
    @keyframes kill{from{transform:scale(1.1);opacity:1;}to{transform:scale(1);opacity:0;}}
    #board.rotated{transform:rotate(180deg);}
    #board.rotated .piece{transform:rotate(180deg);}
    .piece{transition:transform 0.16s;}

    /* side panel */
    .side-col{width:260px;display:flex;flex-direction:column;gap:10px;}
    .players{font-size:13px;color:var(--muted);background:rgba(15,23,42,0.85);border-radius:12px;padding:8px;border:1px solid rgba(31,41,55,0.85);}
    .players-row{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px dashed rgba(30,64,175,0.5);}
    .players-row:last-child{border-bottom:none;}
    .rank-pill{padding:2px 7px;border-radius:999px;font-size:11px;font-weight:600;}
    .rank-bronze{background:rgba(180,83,9,0.12);color:var(--rank-bronze);}
    .rank-silver{background:rgba(156,163,175,0.12);color:var(--rank-silver);}
    .rank-gold{background:rgba(234,179,8,0.12);color:var(--rank-gold);}
    .rank-plat{background:rgba(34,197,94,0.12);color:var(--rank-plat);}
    .rank-diamond{background:rgba(14,165,233,0.12);color:var(--rank-diamond);}
    .rank-nemesis{background:rgba(249,115,22,0.12);color:var(--rank-nemesis);}

    .controls-row{display:flex;gap:6px;}
    .controls-row button{flex:1;font-size:12px;padding:7px 8px;}

    .moves{height:90px;overflow:auto;font-size:12px;color:var(--muted);background:rgba(15,23,42,0.9);border-radius:10px;padding:6px;border:1px solid rgba(31,41,55,0.9);}

    .chat{margin-top:4px;display:flex;flex-direction:column;height:170px;border-radius:10px;background:rgba(15,23,42,0.9);border:1px solid rgba(30,64,175,0.8);overflow:hidden;}
    .chat-log{flex:1;overflow:auto;padding:6px 7px;font-size:12px;}
    .chat-line-meta{color:#6ee7b7;font-size:10px;margin-right:4px;}
    .chat-input{display:flex;border-top:1px solid rgba(30,64,175,0.7);}
    .chat-input input{flex:1;border:none;border-radius:0;background:transparent;padding:6px 8px;font-size:12px;}
    .chat-input button{border-radius:0;border-left:1px solid rgba(30,64,175,0.7);padding:0 13px;font-size:12px;}

    /* Countdown overlay */
    .countdown-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,0.9);z-index:30;}
    .countdown-overlay.active{display:flex;}
    .countdown-number{font-size:96px;font-weight:800;color:#e5e7eb;animation:pulse 0.8s ease-in-out infinite;}
    @keyframes pulse{0%{transform:scale(0.7);opacity:0.5;}50%{transform:scale(1);opacity:1;}100%{transform:scale(0.7);opacity:0.5;}}

    /* Ranks section */
    .rank-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:8px;}
    .rank-card{border-radius:12px;padding:10px;background:radial-gradient(circle at top left,#111827,#020617);border:1px solid rgba(31,41,55,0.9);font-size:12px;}
    .rank-card strong{display:block;margin-bottom:2px;}
    .rank-card span{color:var(--muted);font-size:11px;}

    @media(max-width:960px){
      .app{grid-template-columns:1fr;}
      #boardWrap{flex-direction:column;align-items:center;}
      #board{transform:scale(0.9);}
    }
  </style>
</head>
<body>
<div class="app">

  <!-- LEFT: tabs + play + ranks -->
  <div class="card">
    <h1>Nemesis Chess</h1>
    <div class="sub">Online multiplayer with ranked ladder, AI duels, and in-game chat.</div>

    <div class="tabs">
      <div class="tab active" id="tabPlay">Play</div>
      <div class="tab" id="tabRanks">Ranks</div>
    </div>

    <div id="viewPlay">
      <div class="stack">
        <div>
          <div class="hint">Your name</div>
          <input id="nameInput" placeholder="Enter nickname" />
        </div>

        <div>
          <div class="hint" style="margin-bottom:4px;">Choose a mode</div>
          <button id="playFriendBtn" class="full">Play with Friend</button>
          <button id="playRankedBtn" class="full">Ranked Matchmaking</button>
          <button id="playAIBtn" class="full">Play vs AI</button>
          <div class="hint">Board appears once a game starts.</div>
        </div>

        <div id="friendPanel" style="margin-top:8px;display:none;">
          <div class="hint">Friend room</div>
          <div class="row" style="margin-top:4px;">
            <button id="createRoomBtn" style="flex:1;">Create Room</button>
          </div>
          <div class="row" style="margin-top:6px;">
            <input id="joinCodeInput" placeholder="Enter room code" style="flex:1;" />
            <button id="joinRoomBtn">Join</button>
          </div>
        </div>

        <div class="status" id="statusText">Not connected. Select a mode to begin.</div>
      </div>
    </div>

    <div id="viewRanks" style="display:none;">
      <div class="stack">
        <div>
          <div class="hint">Check your rank</div>
          <input id="rankNameInput" placeholder="Name (same as used in games)" />
          <button id="rankCheckBtn" class="full" style="margin-top:6px;">Show My Rank</button>
        </div>
        <div style="margin-top:10px;">
          <div class="hint">Your current ladder standing</div>
          <div id="rankResult" style="margin-top:4px;font-size:13px;color:var(--muted);">
            No rank loaded yet.
          </div>
        </div>
        <div style="margin-top:14px;">
          <div class="hint">Rank tiers</div>
          <div class="rank-grid">
            <div class="rank-card"><strong>Bronze</strong><span>Below 900 — learning the basics.</span></div>
            <div class="rank-card"><strong>Silver</strong><span>900–1099 — solid fundamentals.</span></div>
            <div class="rank-card"><strong>Gold</strong><span>1100–1299 — tactical awareness.</span></div>
            <div class="rank-card"><strong>Platinum</strong><span>1300–1499 — strong, consistent play.</span></div>
            <div class="rank-card"><strong>Diamond</strong><span>1500–1799 — high-level competitive.</span></div>
            <div class="rank-card"><strong>Nemesis</strong><span>1800+ — feared across the board.</span></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- RIGHT: game area -->
  <div class="card">
    <div class="header-row">
      <div class="pill" id="modeLabel">Mode: -</div>
      <div class="pill" id="turnLabel">Turn: -</div>
    </div>

    <div id="emptyState">
      <h2>No game active</h2>
      <div>Pick a mode on the left to start a game.</div>
    </div>

    <div id="gameContainer">
      <div id="boardWrap">
        <div id="board" aria-label="Chess board"></div>
        <div class="side-col">
          <div class="players" id="playersBox">Waiting for players…</div>
          <div class="controls-row">
            <button id="resetBtn" class="secondary">Reset</button>
            <button id="flipBtn" class="secondary">Flip</button>
            <button id="leaveBtn" class="secondary">Leave</button>
          </div>
          <div>
            <div class="hint" style="margin-bottom:2px;">Moves</div>
            <div id="pgnBox" class="moves"></div>
          </div>
          <div class="chat">
            <div class="chat-log" id="chatLog"></div>
            <div class="chat-input">
              <input id="chatInput" placeholder="Type a message..." />
              <button id="chatSendBtn">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="countdown-overlay" id="countdownOverlay">
  <div class="countdown-number" id="countdownNumber">3</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

// DOM refs
const tabPlay = document.getElementById("tabPlay");
const tabRanks = document.getElementById("tabRanks");
const viewPlay = document.getElementById("viewPlay");
const viewRanks = document.getElementById("viewRanks");

const nameInput = document.getElementById("nameInput");
const playFriendBtn = document.getElementById("playFriendBtn");
const playRankedBtn = document.getElementById("playRankedBtn");
const playAIBtn = document.getElementById("playAIBtn");
const friendPanel = document.getElementById("friendPanel");
const createRoomBtn = document.getElementById("createRoomBtn");
const joinRoomBtn = document.getElementById("joinRoomBtn");
const joinCodeInput = document.getElementById("joinCodeInput");
const statusText = document.getElementById("statusText");

const rankNameInput = document.getElementById("rankNameInput");
const rankCheckBtn = document.getElementById("rankCheckBtn");
const rankResult = document.getElementById("rankResult");

const boardEl = document.getElementById("board");
const modeLabel = document.getElementById("modeLabel");
const turnLabel = document.getElementById("turnLabel");
const emptyState = document.getElementById("emptyState");
const gameContainer = document.getElementById("gameContainer");
const playersBox = document.getElementById("playersBox");
const resetBtn = document.getElementById("resetBtn");
const flipBtn = document.getElementById("flipBtn");
const leaveBtn = document.getElementById("leaveBtn");
const pgnBox = document.getElementById("pgnBox");
const chatLog = document.getElementById("chatLog");
const chatInput = document.getElementById("chatInput");
const chatSendBtn = document.getElementById("chatSendBtn");

const countdownOverlay = document.getElementById("countdownOverlay");
const countdownNumber = document.getElementById("countdownNumber");

let roomId = null;
let myColor = null;
let currentTurn = null;
let myName = null;
let currentMode = "-"; // "friend" | "ranked" | "ai"
let selectedSq = null;
let inGame = false;

// Tabs
tabPlay.addEventListener("click", () => {
  tabPlay.classList.add("active");
  tabRanks.classList.remove("active");
  viewPlay.style.display = "";
  viewRanks.style.display = "none";
});
tabRanks.addEventListener("click", () => {
  tabRanks.classList.add("active");
  tabPlay.classList.remove("active");
  viewPlay.style.display = "none";
  viewRanks.style.display = "";
});

// Board creation (constant orientation)
function createBoard() {
  boardEl.innerHTML = "";
  const ranks = [8,7,6,5,4,3,2,1];
  const files = ["a","b","c","d","e","f","g","h"];
  for (const r of ranks) {
    for (const f of files) {
      const sq = f + r;
      const div = document.createElement("div");
      div.className = "square " + (((r + (f.charCodeAt(0)-96)) % 2 === 0) ? "light":"dark");
      div.dataset.sq = sq;
      const span = document.createElement("span");
      span.className = "piece";
      div.appendChild(span);
      div.addEventListener("click", () => onSquareClick(div));
      boardEl.appendChild(div);
    }
  }
}

const UNICODE = {
  "p":"\u265F","r":"\u265C","n":"\u265E","b":"\u265D","q":"\u265B","k":"\u265A",
  "P":"\u2659","R":"\u2656","N":"\u2658","B":"\u2657","Q":"\u2655","K":"\u2654"
};

function renderFromFen(fen, lastMove) {
  if (!fen) return;
  const parts = fen.split(" ");
  const rows = parts[0].split("/");
  const sqMap = {};
  for (let i = 0; i < 8; i++) {
    const row = rows[i];
    let file = 1;
    for (const ch of row) {
      if (/[1-8]/.test(ch)) file += parseInt(ch, 10);
      else {
        const rank = 8 - i;
        const fileChar = String.fromCharCode(96 + file);
        const sq = fileChar + rank;
        sqMap[sq] = ch;
        file++;
      }
    }
  }
  document.querySelectorAll(".square").forEach(div => {
    const sq = div.dataset.sq;
    const code = sqMap[sq];
    const span = div.querySelector(".piece");
    span.textContent = code ? UNICODE[code] : "";
    div.classList.remove("selected","kill");
  });
  if (lastMove && lastMove.to) {
    const target = document.querySelector(`.square[data-sq="${lastMove.to}"]`);
    if (target && lastMove.captured) {
      target.classList.add("kill");
    }
  }
}

function isMyTurn() {
  return myColor && currentTurn && myColor[0] === currentTurn;
}

function onSquareClick(div) {
  if (!inGame || !roomId) return;
  if (!isMyTurn()) return;
  const sq = div.dataset.sq;
  const pieceChar = div.querySelector(".piece").textContent;
  if (!selectedSq) {
    if (!pieceChar) return;
    const cp = pieceChar.codePointAt(0);
    const isWhitePiece = cp >= 0x2654 && cp <= 0x2659;
    const isBlackPiece = cp >= 0x265A && cp <= 0x265F;
    if ((myColor === "w" && !isWhitePiece) || (myColor === "b" && !isBlackPiece)) return;
    selectedSq = sq;
    div.classList.add("selected");
  } else {
    if (selectedSq === sq) {
      selectedSq = null;
      document.querySelectorAll(".square").forEach(s => s.classList.remove("selected"));
      return;
    }
    socket.emit("move", { room: roomId, from: selectedSq, to: sq }, (res) => {
      if (!res || !res.ok) {
        // you can show a toast here if desired
      }
    });
    selectedSq = null;
    document.querySelectorAll(".square").forEach(s => s.classList.remove("selected"));
  }
}

function setModeLabel() {
  let label = "Mode: -";
  if (currentMode === "friend") label = "Mode: Friend";
  if (currentMode === "ranked") label = "Mode: Ranked";
  if (currentMode === "ai") label = "Mode: vs AI";
  modeLabel.textContent = label;
}
function setStatus(text) {
  statusText.textContent = text;
}

// Rank helper
function rankFromElo(e) {
  if (e < 900) return { name:"Bronze", css:"rank-bronze" };
  if (e < 1100) return { name:"Silver", css:"rank-silver" };
  if (e < 1300) return { name:"Gold", css:"rank-gold" };
  if (e < 1500) return { name:"Platinum", css:"rank-plat" };
  if (e < 1800) return { name:"Diamond", css:"rank-diamond" };
  return { name:"Nemesis", css:"rank-nemesis" };
}

function updatePlayersBox(players) {
  playersBox.innerHTML = "";
  if (!players || !players.length) {
    playersBox.textContent = "Waiting for players…";
    return;
  }
  for (const p of players) {
    const row = document.createElement("div");
    row.className = "players-row";
    const rk = rankFromElo(p.elo || 0);
    row.innerHTML = `<span>${p.name} (${p.color.toUpperCase()})</span><span class="rank-pill ${rk.css}">${rk.name}</span>`;
    playersBox.appendChild(row);
  }
}

// Countdown
function startCountdownAndShowBoard() {
  inGame = true;
  emptyState.style.display = "none";
  gameContainer.style.display = "block";
  createBoard();

  let n = 3;
  countdownOverlay.classList.add("active");
  countdownNumber.textContent = n;
  const t = setInterval(() => {
    n--;
    if (n > 0) countdownNumber.textContent = n;
    else if (n === 0) countdownNumber.textContent = "GO";
    else {
      clearInterval(t);
      countdownOverlay.classList.remove("active");
    }
  }, 800);
}

// Modes
playFriendBtn.addEventListener("click", () => {
  currentMode = "friend";
  setModeLabel();
  friendPanel.style.display = "";
  setStatus("Friend mode: create a room or join by code.");
});

playRankedBtn.addEventListener("click", () => {
  currentMode = "ranked";
  setModeLabel();
  friendPanel.style.display = "none";
  myName = nameInput.value.trim() || "Player";
  socket.emit("rankedQueue", { name: myName });
  setStatus("Searching for a ranked opponent…");
});

playAIBtn.addEventListener("click", () => {
  currentMode = "ai";
  setModeLabel();
  friendPanel.style.display = "none";
  myName = nameInput.value.trim() || "Player";
  socket.emit("aiGame", { name: myName }, (res) => {
    if (!res || !res.ok) {
      setStatus("Failed to start AI game.");
      return;
    }
    roomId = res.room;
    myColor = res.color;
    currentTurn = res.turn;
    setStatus("Playing vs AI as " + (myColor === "w" ? "White" : "Black") + ".");
    if (myColor === "b") boardEl.classList.add("rotated"); else boardEl.classList.remove("rotated");
    updatePlayersBox(res.players);
    pgnBox.textContent = res.pgn || "";
    startCountdownAndShowBoard();
    renderFromFen(res.fen);
  });
});

createRoomBtn.addEventListener("click", () => {
  currentMode = "friend";
  setModeLabel();
  myName = nameInput.value.trim() || "Player";
  socket.emit("create", { name: myName }, (res) => {
    if (!res) return;
    roomId = res.room;
    joinRoom(roomId);
  });
});

joinRoomBtn.addEventListener("click", () => {
  currentMode = "friend";
  setModeLabel();
  const code = joinCodeInput.value.trim();
  if (!code) return;
  roomId = code;
  joinRoom(roomId);
});

function joinRoom(code) {
  myName = myName || nameInput.value.trim() || "Player";
  socket.emit("join", { room: code, name: myName }, (res) => {
    if (!res || !res.ok) {
      setStatus(res && res.err ? res.err : "Join failed.");
      return;
    }
    roomId = res.room || code;
    myColor = res.color;
    currentTurn = res.turn;
    setStatus("In room " + roomId + " as " + myName + " (" + myColor.toUpperCase() + ").");
    if (myColor === "b") boardEl.classList.add("rotated"); else boardEl.classList.remove("rotated");
    updatePlayersBox(res.players);
    pgnBox.textContent = res.pgn || "";
    startCountdownAndShowBoard();
    renderFromFen(res.fen);
  });
}

// Ranked found
socket.on("rankedFound", (payload) => {
  currentMode = "ranked";
  setModeLabel();
  const { room, fen, turn, players, asColor, pgn } = payload;
  roomId = room;
  myColor = asColor;
  currentTurn = turn;
  if (myColor === "b") boardEl.classList.add("rotated"); else boardEl.classList.remove("rotated");
  updatePlayersBox(players);
  pgnBox.textContent = pgn || "";
  setStatus("Ranked opponent found! You are " + (myColor === "w" ? "White" : "Black") + ".");
  startCountdownAndShowBoard();
  renderFromFen(fen);
});

// Reset / Flip / Leave
resetBtn.addEventListener("click", () => {
  if (!roomId) return;
  socket.emit("reset", { room: roomId });
});
flipBtn.addEventListener("click", () => {
  boardEl.classList.toggle("rotated");
});
leaveBtn.addEventListener("click", () => {
  window.location.reload();
});

// Chat
chatSendBtn.addEventListener("click", () => {
  if (!roomId) return;
  const msg = chatInput.value.trim();
  if (!msg) return;
  const nm = myName || nameInput.value.trim() || "Player";
  socket.emit("chat", { room: roomId, name: nm, msg });
  chatInput.value = "";
});
chatInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") chatSendBtn.click();
});

socket.on("chat", (c) => {
  const line = document.createElement("div");
  const date = new Date(c.ts || Date.now());
  const t = date.toTimeString().slice(0,5);
  line.innerHTML = `<span class="chat-line-meta">[${t}]</span><strong>${c.name}:</strong> ${c.msg}`;
  chatLog.appendChild(line);
  chatLog.scrollTop = chatLog.scrollHeight;
});

// Game state
socket.on("state", (s) => {
  if (s.turn) {
    currentTurn = s.turn;
    turnLabel.textContent = "Turn: " + (currentTurn === "w" ? "White" : "Black");
  }
  if (s.players) updatePlayersBox(s.players);
  if (s.fen) renderFromFen(s.fen, s.lastMove);
  if (s.pgn) pgnBox.textContent = s.pgn;
});

// Ranks view: check own rank
rankCheckBtn.addEventListener("click", () => {
  const nm = rankNameInput.value.trim() || nameInput.value.trim() || "Player";
  socket.emit("eloSelf", { name: nm }, (res) => {
    const elo = res && res.elo ? res.elo : 1000;
    const rk = rankFromElo(elo);
    rankResult.innerHTML = `
      <div style="margin-bottom:4px;">Player <strong>${nm}</strong></div>
      <div style="margin-bottom:4px;">Rating: <strong>${elo}</strong></div>
      <span class="rank-pill ${rk.css}">${rk.name}</span>
      <div style="margin-top:6px;">Keep playing ranked games to climb to Nemesis.</div>
    `;
  });
});

// Init
createBoard();
setModeLabel();
setStatus("Not connected. Select a mode to begin.");
</script>
</body>
</html>
