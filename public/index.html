<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Ultimate Chess v5</title>
<style>
body{background:#020617;color:white;font-family:Orbitron;margin:0}
#menu,#game{display:flex;justify-content:center;align-items:center;min-height:100vh}
.panel{background:#111827;padding:30px;border-radius:14px;text-align:center}
button,input{margin-top:10px;padding:10px;border-radius:8px;border:none}
#board{display:grid;grid-template-columns:repeat(8,60px);grid-template-rows:repeat(8,60px)}
.square{display:flex;align-items:center;justify-content:center;font-size:32px}
.light{background:#eadbbf}.dark{background:#b0825a}
.kill{animation:boom .3s}
@keyframes boom{0%{transform:scale(.5)}100%{transform:scale(1.2)}}
#side{margin-left:20px}
</style>
</head>
<body>

<div id="menu">
  <div class="panel">
    <h1>ULTIMATE CHESS</h1>
    <input id="name" placeholder="Name">
    <button id="ranked">Ranked Match</button>
    <button id="ai">Play vs AI</button>
    <input id="room" placeholder="Room">
    <button id="join">Join</button>
  </div>
</div>

<div id="game" style="display:none">
  <div id="board"></div>
  <div id="side">
    <div id="players"></div>
    <div id="turn"></div>
    <div id="chat"></div>
    <input id="msg" placeholder="Say something">
    <button id="send">Send</button>
    <button onclick="location.reload()">Leave</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const board=document.getElementById('board');
const menu=document.getElementById('menu');
const game=document.getElementById('game');
const chatEl=document.getElementById('chat');

let roomId=null,myColor=null,turn=null,selected=null,nameEl=document.getElementById('name').value;

const UNICODE={'p':'♟','r':'♜','n':'♞','b':'♝','q':'♛','k':'♚','P':'♙','R':'♖','N':'♘','B':'♗','Q':'♕','K':'♔'};

function createBoard(){
  board.innerHTML='';
  const ranks=[8,7,6,5,4,3,2,1],files=['a','b','c','d','e','f','g','h'];
  for(const r of ranks)for(const f of files){
    const d=document.createElement('div');
    d.className='square '+(((r+(f.charCodeAt(0)-96))%2)?'dark':'light');
    d.dataset.sq=f+r;
    d.innerHTML='<span></span>';
    d.onclick=()=>onClick(d);
    board.appendChild(d);
  }
}

function render(fen,last){
  const rows=fen.split(' ')[0].split('/'); let map={};
  for(let i=0;i<8;i++){
    let file=1;
    for(const c of rows[i]){
      if(/[1-8]/.test(c)) file+=+c;
      else{map[String.fromCharCode(96+file)+(8-i)]=c;file++;}
    }
  }
  document.querySelectorAll('.square').forEach(s=>{
    const p=map[s.dataset.sq];
    s.firstChild.textContent=p?UNICODE[p]:'';
    s.classList.remove('kill');
  });
  if(last){
    const sq=document.querySelector(`[data-sq='${last.to}']`);
    if(sq) sq.classList.add('kill');
  }
}

function onClick(el){
  if(!roomId||myColor!==turn) return;
  if(!selected){
    if(!el.firstChild.textContent) return;
    selected=el.dataset.sq;
  }else{
    socket.emit('move',{room:roomId,from:selected,to:el.dataset.sq});
    selected=null;
  }
}

document.getElementById('ranked').onclick=()=>{
  nameEl=document.getElementById('name').value||'Player';
  socket.emit('rankedQueue',{name:nameEl});
};

socket.on('rankedFound',r=>{
  joinRoom(r.room);
});

document.getElementById('ai').onclick=()=>{
  nameEl=document.getElementById('name').value||'Player';
  socket.emit('aiGame',{name:nameEl},res=>joinRoom(res.room));
};

document.getElementById('join').onclick=()=>{
  nameEl=document.getElementById('name').value||'Player';
  joinRoom(document.getElementById('room').value);
};

function joinRoom(code){
  socket.emit('join',{room:code,name:nameEl},res=>{
    roomId=code; myColor=res.color;
    menu.style.display='none'; game.style.display='flex';
    createBoard();
    render(res.fen);
  });
}

document.getElementById('send').onclick=()=>{
  const msg=document.getElementById('msg').value;
  socket.emit('chat',{room:roomId,name:nameEl,msg});
};

socket.on('chat',c=>{
  chatEl.innerHTML+=`<div><b>${c.name}:</b> ${c.msg}</div>`;
});

socket.on('state',s=>{
  turn=s.turn;
  render(s.fen,s.lastMove);
});
</script>
</body>
</html>
